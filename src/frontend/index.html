<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Canin Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .nav-item.active { background-color: #1e3a8a; color: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex">

    <!-- Mock Backend API and Data Structures (Expanded for Staff/Vet Creation and Deletion) -->
    <script>
        /**
         * Animal Shelter Mock Backend (integrated)
         */

        // New ID tracking
        let nextPersonID = 10; 
        let nextAnimalID = 5;

        const mockDB = {
            persons: [
                { personID: 1, firstName: 'Alice', lastName: 'Johnson', gender: 'F', age: 35, email: 'alice.j@shelter.org', phoneNo: '555-0101', address: '123 Main St', role: 'employee' },
                { personID: 2, firstName: 'Bob', lastName: 'Smith', gender: 'M', age: 45, email: 'bob.s@shelter.org', phoneNo: '555-0102', address: '456 Oak Ave', role: 'employee' },
                { personID: 7, firstName: 'George', lastName: 'Lucas', gender: 'M', age: 22, email: 'george.l@shelter.org', phoneNo: '555-0107', address: '500 Tech Lane', role: 'employee' },
                { personID: 4, firstName: 'Diana', lastName: 'Prince', gender: 'F', age: 55, email: 'diana.p@clinic.com', phoneNo: '555-0104', address: '101 Health Rd', role: 'vet' },
                { personID: 6, firstName: 'Fiona', lastName: 'Gleason', gender: 'F', age: 40, email: 'fiona.g@clinic.com', phoneNo: '555-0106', address: '303 Care St', role: 'vet' },
                { personID: 5, firstName: 'Ethan', lastName: 'Hunt', gender: 'M', age: 32, email: 'ethan.h@home.com', phoneNo: '555-0105', address: '202 Mission Blvd', role: 'adopter' },
            ],
            departments: [
                { deptID: 1, deptName: 'Animal Care' },
                { deptID: 2, deptName: 'Administration' },
                { deptID: 3, deptName: 'Medical & Health' },
            ],
            employees: [
                { employeeID: 1, hireDate: '2018-06-15', position: 'Animal Handler', deptID: 1, supervisorID: 2, salary: 42000.00, employmentType: 'Full-time', workShift: 'Day' },
                { employeeID: 2, hireDate: '2015-01-01', position: 'Shelter Manager', deptID: 2, supervisorID: null, salary: 65000.00, employmentType: 'Full-time', workShift: 'Day' },
                { employeeID: 7, hireDate: '2024-01-10', position: 'Maintenance Staff', deptID: 1, supervisorID: 1, salary: 35000.00, employmentType: 'Full-time', workShift: 'Day' },
            ],
            clinics: [
                { clinicID: 1, clinicName: 'Vet Central Hospital', location: '1500 Elm Street' },
                { clinicID: 2, clinicName: 'Happy Tails Clinic', location: '85 Pet Avenue' },
            ],
            vets: [
                { vetID: 4, specialization: 'Surgery', years_of_experience: 30, clinicID: 1, vet_license_no: 'VET-98765' },
                { vetID: 6, specialization: 'Internal Medicine', years_of_experience: 15, clinicID: 2, vet_license_no: 'VET-12345' },
            ],
            cages: [
                { cageID: 101, locateZone: 'Dog Zone A', size: 'Large', cageStatus: 'Occupied' },
                { cageID: 102, locateZone: 'Dog Zone A', size: 'Medium', cageStatus: 'Occupied' },
                { cageID: 201, locateZone: 'Cat Room B', size: 'Small', cageStatus: 'Occupied' },
                { cageID: 202, locateZone: 'Cat Room B', size: 'Small', cageStatus: 'Available' },
            ],
            foods: [
                { foodID: 1, foodName: 'Royal Canin Dog', foodType: 'Dry', price: 15.50, quantityAvailable: 50 },
                { foodID: 3, foodName: 'Purina Wet Cat', foodType: 'Wet', price: 1.25, quantityAvailable: 200 }
            ],
            animals: [
                { animalID: 1, animalName: 'Max', species: 'Dog', breed: 'Labrador', age: 3, adoptionStatus: 'Adopted', healthCondition: 'Healthy', cageID: 101, foodID: 1, employeeID: 1, gender: 'M' },
                { animalID: 2, animalName: 'Luna', species: 'Cat', breed: 'Siamese', age: 1, adoptionStatus: 'Available', healthCondition: 'Mild cold', cageID: 201, foodID: 3, employeeID: 1, gender: 'F' },
                { animalID: 3, animalName: 'Rocky', species: 'Dog', breed: 'Beagle', age: 5, adoptionStatus: 'Available', healthCondition: 'Needs dental work', cageID: 102, foodID: 1, employeeID: 7, gender: 'M' },
                { animalID: 4, animalName: 'Shadow', species: 'Cat', breed: 'Maine Coon', age: 2, adoptionStatus: 'Pending', healthCondition: 'Healthy', cageID: 201, foodID: 3, employeeID: 7, gender: 'M' },
            ],
            adopters: [ /* ... */ ], 
            orders: [ /* ... */ ], 
            treatments: [ /* ... */ ],
            vaccines: [ /* ... */ ],
            medicines: [ /* ... */ ],
            adoptions: [ /* ... */ ]
        };

        // Utility Functions for Joining Data (same as before)
        function getPersonDetails(person) {
            const employee = mockDB.employees.find(e => e.employeeID === person.personID);
            const vet = mockDB.vets.find(v => v.vetID === person.personID);
            const dept = employee ? mockDB.departments.find(d => d.deptID === employee.deptID) : null;
            const clinic = vet ? mockDB.clinics.find(c => c.clinicID === vet.clinicID) : null;
            
            if (employee) {
                return {
                    ...person,
                    type: 'Employee',
                    role: employee.position,
                    department: dept?.deptName || 'N/A',
                    details: `Salary: $${employee.salary.toFixed(2)}, Hired: ${employee.hireDate}`
                };
            }
            if (vet) {
                return {
                    ...person,
                    type: 'Vet',
                    role: vet.specialization,
                    department: clinic?.clinicName || 'N/A', // Using Clinic Name for the 'Department' column
                    details: `License: ${vet.vet_license_no}, Exp: ${vet.years_of_experience} yrs`
                };
            }
            return { ...person, type: 'Other', role: 'N/A', department: 'N/A', details: '' };
        }

        function getAnimalDetails(animal) {
            const handler = mockDB.employees.find(e => e.employeeID === animal.employeeID);
            const handlerPerson = mockDB.persons.find(p => p.personID === handler?.employeeID);
            const cage = mockDB.cages.find(c => c.cageID === animal.cageID);
            const food = mockDB.foods.find(f => f.foodID === animal.foodID);

            return {
                ...animal,
                cageLocation: cage ? `${cage.locateZone} (ID: ${cage.cageID})` : 'N/A',
                foodName: food?.foodName || 'N/A',
                assignedHandler: handlerPerson ? `${handlerPerson.firstName} ${handlerPerson.lastName}` : 'Unassigned',
                handlerPosition: handler?.position || 'N/A'
            };
        }

        // --- API Router (Mocking Express routes) ---
        const apiRouter = {
            '/api/animals': (method, data) => {
                if (method === 'GET') {
                    return mockDB.animals.map(getAnimalDetails);
                } else if (method === 'POST') {
                    const newAnimal = { 
                        animalID: nextAnimalID++, 
                        ...data, 
                        adoptionStatus: 'Available',
                        arrivalDate: new Date().toISOString().split('T')[0],
                        employeeID: 1, 
                        foodID: 1, 
                        cageID: 202 
                    };
                    mockDB.animals.push(newAnimal);
                    return getAnimalDetails(newAnimal);
                }
                return { status: 405, message: 'Method Not Allowed' };
            },

            '/api/staff/options': (method) => {
                if (method === 'GET') {
                    return {
                        departments: mockDB.departments,
                        clinics: mockDB.clinics,
                        supervisors: mockDB.employees.map(e => {
                            const p = mockDB.persons.find(p => p.personID === e.employeeID);
                            return { id: e.employeeID, name: `${p.firstName} ${p.lastName} (${e.position})` };
                        })
                    };
                }
                return { status: 405, message: 'Method Not Allowed' };
            },

            '/api/staff': (method, data, id) => { // Added 'id' parameter for DELETE handling
                if (method === 'GET') {
                    const staff = mockDB.persons
                        .filter(p => p.role === 'employee' || p.role === 'vet')
                        .map(getPersonDetails)
                        .sort((a, b) => a.lastName.localeCompare(b.lastName));
                    return staff;
                } else if (method === 'POST') {
                    const personID = nextPersonID++;
                    
                    // 1. Create PERSON record
                    const newPerson = {
                        personID,
                        firstName: data.firstName,
                        lastName: data.lastName,
                        gender: data.gender,
                        age: parseInt(data.age),
                        email: data.email,
                        phoneNo: data.phoneNo,
                        address: data.address,
                        role: data.staffType 
                    };
                    mockDB.persons.push(newPerson);

                    let staffRecord;
                    if (data.staffType === 'employee') {
                        // 2. Create EMPLOYEE record
                        staffRecord = {
                            employeeID: personID,
                            hireDate: data.hireDate,
                            workShift: data.workShift,
                            salary: parseFloat(data.salary),
                            employmentType: data.employmentType,
                            position: data.position,
                            deptID: parseInt(data.deptID),
                            supervisorID: data.supervisorID ? parseInt(data.supervisorID) : null
                        };
                        mockDB.employees.push(staffRecord);
                    } else if (data.staffType === 'vet') {
                        // 2. Create VET record
                        staffRecord = {
                            vetID: personID,
                            vet_license_no: data.vet_license_no,
                            specialization: data.specialization,
                            years_of_experience: parseInt(data.years_of_experience),
                            clinicID: parseInt(data.clinicID)
                        };
                        mockDB.vets.push(staffRecord);
                    }

                    // Return the joined details
                    return getPersonDetails(newPerson);
                } else if (method === 'DELETE') {
                    const personIdToDelete = parseInt(id);
                    // 1. Find person
                    const personIndex = mockDB.persons.findIndex(p => p.personID === personIdToDelete);
                    if (personIndex === -1) {
                        return { status: 404, message: 'Staff member not found.' };
                    }
                    const role = mockDB.persons[personIndex].role;

                    // 2. Remove from specific staff table (Employee/Vet)
                    if (role === 'employee') {
                        mockDB.employees = mockDB.employees.filter(e => e.employeeID !== personIdToDelete);
                        // Clear supervisorID references where this employee was a supervisor
                        mockDB.employees.forEach(e => {
                            if (e.supervisorID === personIdToDelete) e.supervisorID = null;
                        });
                        // NOTE: In a real system, you'd need to reassign animals cared for by this employee.
                    } else if (role === 'vet') {
                        mockDB.vets = mockDB.vets.filter(v => v.vetID !== personIdToDelete);
                    }

                    // 3. Remove from PERSON table
                    mockDB.persons.splice(personIndex, 1);

                    return { status: 200, message: 'Staff member deleted successfully.' };
                }
                return { status: 405, message: 'Method Not Allowed' };
            },

            '/api/dashboard': (method) => {
                if (method === 'GET') {
                    const available = mockDB.animals.filter(a => a.adoptionStatus === 'Available').length;
                    const pending = mockDB.animals.filter(a => a.adoptionStatus === 'Pending').length;
                    const adopted = mockDB.animals.filter(a => a.adoptionStatus === 'Adopted').length;
                    const totalAnimals = mockDB.animals.length;
                    const totalStaff = mockDB.employees.length + mockDB.vets.length;
                    const availableCages = mockDB.cages.filter(c => c.cageStatus === 'Available').length;

                    return {
                        totalAnimals: totalAnimals,
                        availableForAdoption: available,
                        pendingAdoptions: pending,
                        totalStaff: totalStaff,
                        availableCages: availableCages,
                        totalFoods: mockDB.foods.length
                    };
                }
                return { status: 405, message: 'Method Not Allowed' };
            }
        };

        // Global mock function to simulate fetching data from the backend
        window.mockFetch = async (url, options = {}) => {
            const method = options.method || 'GET';
            const body = options.body ? JSON.parse(options.body) : {};

            // Logic to parse ID from URL for DELETE /api/staff/:id
            const urlParts = url.split('/');
            let route = url;
            let id = null;

            if (urlParts.length === 5 && urlParts[3] === 'staff' && (method === 'DELETE' || !isNaN(parseInt(urlParts[4])))) {
                id = urlParts[4]; // The ID is the last segment
                route = urlParts.slice(0, 4).join('/'); // Route becomes '/api/staff'
            }
            
            const routeHandler = apiRouter[route];

            if (!routeHandler) {
                return { ok: false, status: 404, json: async () => ({ message: 'Not Found' }) };
            }

            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 300));

            try {
                // Pass the ID to the route handler if available
                const result = routeHandler(method, body, id); 
                return {
                    ok: true,
                    status: 200,
                    json: async () => result
                };
            } catch (error) {
                console.error('Mock API Error:', error);
                return { ok: false, status: 500, json: async () => ({ message: 'Internal Server Error' }) };
            }
        };

    </script>

    <!-- Sidebar Navigation -->
    <nav class="w-64 bg-blue-900 h-screen p-4 sticky top-0 shadow-xl">
        <h2 class="text-2xl font-bold text-white mb-8">Shelter Admin</h2>
        <ul id="nav-list">
            <li><a href="#" data-page="dashboard" class="nav-item">üè† Dashboard</a></li>
            <li><a href="#" data-page="animals" class="nav-item">üêæ Animals</a></li>
            <li><a href="#" data-page="staff" class="nav-item active">üë• Staff & Vets</a></li>
            <li class="mt-4 text-gray-400 font-semibold text-sm uppercase">Quick Links</li>
            <li><a href="#" data-page="food" class="nav-item">üõí Food & Supply (WIP)</a></li>
            <li><a href="#" data-page="clinics" class="nav-item">üè• Clinics & Meds (WIP)</a></li>
            <li><a href="#" data-page="adopters" class="nav-item">üß° Adopters (WIP)</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800">Royal Canin Animal Shelter</h1>
            <p class="text-xl text-gray-500" id="page-subtitle">Database Management Dashboard</p>
        </header>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-10 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-blue-600">Fetching data...</p>
        </div>

        <!-- Content Placeholder -->
        <div id="content-container">
            <!-- Dynamic content will be loaded here -->
        </div>

        <!-- Hidden Templates for Pages -->
        <template id="dashboard-template">
             <section id="dashboard-metrics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <!-- Metrics will be inserted here -->
            </section>
        </template>

        <template id="animals-template">
            <!-- Add New Animal Form (Same as previous version) -->
            <section class="mb-10 p-6 bg-white shadow-lg rounded-xl">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Register New Animal</h2>
                <form id="add-animal-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="animalName" placeholder="Name (e.g., Buddy)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="species" placeholder="Species (e.g., Dog)" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="breed" placeholder="Breed (e.g., Shepherd)" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="number" id="age" placeholder="Age" min="0" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <select id="gender" required class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>Select Gender</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                    <input type="text" id="healthCondition" placeholder="Health Condition" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button type="submit" class="md:col-span-3 p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                        Add Animal to Shelter
                    </button>
                </form>
                <div id="form-message-animal" class="mt-3 text-center text-sm font-medium hidden"></div>
            </section>

            <!-- Animal List Section (Same as previous version) -->
            <section>
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Current Shelter Animals</h2>
                <div id="animal-list-container" class="bg-white shadow-lg rounded-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name / ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Species/Breed</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Health</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Cage/Handler</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="animal-list" class="bg-white divide-y divide-gray-200">
                            <!-- Animal rows will be inserted here -->
                        </tbody>
                    </table>
                    <p id="no-animals-message" class="text-center p-6 text-gray-500 hidden">No animals currently in the system.</p>
                </div>
            </section>
        </template>

        <!-- New Staff Template -->
        <template id="staff-template">
            <!-- Add New Staff Form -->
            <section class="mb-10 p-6 bg-white shadow-lg rounded-xl">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Register New Employee or Vet</h2>
                <form id="add-staff-form">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <!-- Staff Type Selector (The central switch) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Staff Type</label>
                            <select id="staffType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="" disabled selected>Select Role Type</option>
                                <option value="employee">Shelter Employee</option>
                                <option value="vet">Affiliated Vet</option>
                            </select>
                        </div>
                    </div>

                    <!-- General Person Fields (Always visible) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg">
                        <h3 class="md:col-span-4 text-lg font-semibold text-gray-800 border-b pb-2 mb-3">General Information (Person)</h3>
                        <input type="text" id="firstName" placeholder="First Name" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="text" id="lastName" placeholder="Last Name" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="email" id="email" placeholder="Email Address" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="text" id="phoneNo" placeholder="Phone Number" class="p-3 border border-gray-300 rounded-lg">
                        <input type="number" id="age" placeholder="Age" min="18" max="100" required class="p-3 border border-gray-300 rounded-lg">
                        <select id="gender" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Gender</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="O">Other</option>
                        </select>
                        <input type="text" id="address" placeholder="Address (Street, City, State)" class="md:col-span-2 p-3 border border-gray-300 rounded-lg">
                    </div>

                    <!-- EMPLOYEE Specific Fields -->
                    <div id="employee-fields" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg bg-blue-50 hidden">
                        <h3 class="md:col-span-4 text-lg font-semibold text-blue-700 border-b pb-2 mb-3">Employee Details</h3>
                        <input type="date" id="hireDate" placeholder="Hire Date" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="text" id="position" placeholder="Position (e.g., Coordinator)" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="number" id="salary" placeholder="Annual Salary" min="0" required class="p-3 border border-gray-300 rounded-lg">
                        <select id="employmentType" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Employment Type</option>
                            <option value="Full-time">Full-time</option>
                            <option value="Part-time">Part-time</option>
                        </select>
                        <select id="workShift" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Work Shift</option>
                            <option value="Day">Day</option>
                            <option value="Afternoon">Afternoon</option>
                            <option value="Night">Night</option>
                        </select>
                        <select id="deptID" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Select Department</option>
                        </select>
                        <select id="supervisorID" class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="">Select Supervisor (Optional)</option>
                        </select>
                    </div>

                    <!-- VET Specific Fields -->
                    <div id="vet-fields" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg bg-pink-50 hidden">
                        <h3 class="md:col-span-4 text-lg font-semibold text-pink-700 border-b pb-2 mb-3">Vet Details</h3>
                        <input type="text" id="vet_license_no" placeholder="License Number" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="text" id="specialization" placeholder="Specialization (e.g., Surgery)" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="number" id="years_of_experience" placeholder="Years of Experience" min="0" required class="p-3 border border-gray-300 rounded-lg">
                        <select id="clinicID" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Affiliated Clinic</option>
                        </select>
                    </div>

                    <button type="submit" class="w-full p-3 mt-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                        Register Staff Member
                    </button>
                </form>
                <div id="form-message" class="mt-3 text-center text-sm font-medium hidden"></div>
            </section>

            <!-- Staff List Section (Updated) -->
            <section>
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Staff Directory</h2>
                <div id="staff-list-container" class="bg-white shadow-lg rounded-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name / Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role / Dept/Clinic</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Details</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Type / Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staff-list" class="bg-white divide-y divide-gray-200">
                            <!-- Staff rows will be inserted here -->
                        </tbody>
                    </table>
                    <p id="no-staff-message" class="text-center p-6 text-gray-500 hidden">No staff members found.</p>
                </div>
            </section>
        </template>

        <template id="wip-template">
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                <p class="font-bold">Work In Progress</p>
                <p>This management section is coming soon! Please use the Dashboard, Animal, and Staff pages for now.</p>
            </div>
        </template>
    </main>
    
    <!-- Custom Confirmation Modal (Replaces alert/confirm) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold text-red-700 mb-4" id="modal-title">Confirm Action</h3>
            <p class="text-gray-700 mb-6" id="modal-message">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold">Confirm Delete</button>
            </div>
        </div>
    </div>


    <!-- Frontend JavaScript Logic -->
    <script>
        const contentContainer = document.getElementById('content-container');
        const loadingElement = document.getElementById('loading');
        const navList = document.getElementById('nav-list');
        const pageSubtitle = document.getElementById('page-subtitle');
        let currentPage = 'staff'; 

        const statusColors = {
            'Available': 'bg-green-100 text-green-800',
            'Pending': 'bg-yellow-100 text-yellow-800',
            'Adopted': 'bg-blue-100 text-blue-800',
            'Returned': 'bg-red-100 text-red-800'
        };

        // Utility to display loading state
        function setLoading(isLoading) {
            loadingElement.classList.toggle('hidden', !isLoading);
            contentContainer.classList.toggle('opacity-50', isLoading);
        }
        
        // Function to show transient form message
        function showMessage(msg, colorClass, targetId = 'form-message') {
            const formMessage = document.getElementById(targetId);
            if (formMessage) {
                formMessage.textContent = msg;
                formMessage.className = `mt-3 text-center text-sm font-medium ${colorClass}`;
                formMessage.classList.remove('hidden');
                setTimeout(() => {
                    formMessage.classList.add('hidden');
                }, 5000);
            }
        }

        // Custom Modal Logic (Replaces window.confirm)
        function showConfirmModal(title, message, confirmText = 'Confirm Delete', confirmColor = 'bg-red-600') {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            // Reset color class before setting the new one
            confirmBtn.className = confirmBtn.className.replace(/bg-([a-z]+)-600/g, 'bg-red-600'); 
            confirmBtn.classList.remove('bg-red-600'); 
            confirmBtn.classList.add(confirmColor);
            confirmBtn.textContent = confirmText;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex'); // Use flex to center

            return new Promise(resolve => {
                const handleConfirm = () => {
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                };

                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }


        // --- View Rendering Functions ---

        async function renderDashboard() {
            pageSubtitle.textContent = 'Management Dashboard Overview';
            const template = document.getElementById('dashboard-template').content.cloneNode(true);
            contentContainer.innerHTML = '';
            contentContainer.appendChild(template);
            document.getElementById('dashboard-metrics').innerHTML = '<p class="p-4">Dashboard metrics loading...</p>';
            fetchDashboardMetrics();
        }
        
        async function fetchDashboardMetrics() {
             const dashboardMetrics = document.getElementById('dashboard-metrics');
            try {
                const response = await window.mockFetch('/api/dashboard');
                const metrics = await response.json();
                const metricsData = [
                    { title: 'Total Animals', value: metrics.totalAnimals, icon: 'üêæ', color: 'blue' },
                    { title: 'Available for Adoption', value: metrics.availableForAdoption, icon: 'üè†', color: 'green' },
                    { title: 'Pending Adoptions', value: metrics.pendingAdoptions, icon: '‚è±Ô∏è', color: 'yellow' },
                    { title: 'Total Staff (Emp+Vet)', value: metrics.totalStaff, icon: 'üßë‚Äçü§ù‚Äçüßë', color: 'purple' },
                ];
                dashboardMetrics.innerHTML = metricsData.map(item => `
                    <div class="bg-white p-6 rounded-xl shadow-md border-b-4 border-${item.color}-500 transform hover:scale-[1.01] transition-transform">
                        <div class="flex items-center">
                            <span class="text-3xl mr-3">${item.icon}</span>
                            <div>
                                <p class="text-sm font-medium text-gray-500">${item.title}</p>
                                <p class="text-3xl font-bold text-gray-900">${item.value}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                dashboardMetrics.innerHTML = '<p class="text-red-500 col-span-4 p-4">Could not load dashboard data.</p>';
            }
        }
        
        async function renderAnimals() {
            pageSubtitle.textContent = 'Animal Shelter Management';
            const template = document.getElementById('animals-template').content.cloneNode(true);
            contentContainer.innerHTML = '';
            contentContainer.appendChild(template);

            const form = contentContainer.querySelector('#add-animal-form');
            if (form) {
                form.addEventListener('submit', handleAddAnimal);
            }

            await fetchAnimalList();
        }

        async function fetchAnimalList() { 
            setLoading(true);
            const animalListBody = document.getElementById('animal-list');
            const noAnimalsMessage = document.getElementById('no-animals-message');
            
            if (animalListBody) animalListBody.innerHTML = ''; 

            try {
                const response = await window.mockFetch('/api/animals');
                const animals = await response.json();

                if (animals.length === 0) {
                    if (noAnimalsMessage) noAnimalsMessage.classList.remove('hidden');
                } else {
                    if (noAnimalsMessage) noAnimalsMessage.classList.add('hidden');
                    animals.forEach(animal => {
                        const statusClass = statusColors[animal.adoptionStatus] || 'bg-gray-100 text-gray-800';
                        const row = `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${animal.animalName} (ID: ${animal.animalID})</div>
                                    <div class="text-xs text-gray-500">Age: ${animal.age || 'N/A'}, ${animal.gender}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${animal.species} / ${animal.breed || 'Mixed'}
                                </td>
                                <td class="px-6 py-4 whitespace-normal text-sm text-gray-500 hidden sm:table-cell">
                                    ${animal.healthCondition}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden lg:table-cell">
                                    <span class="font-semibold">${animal.cageLocation}</span><br>
                                    <span class="text-xs">Handler: ${animal.assignedHandler} (${animal.handlerPosition})</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                        ${animal.adoptionStatus}
                                    </span>
                                </td>
                            </tr>
                        `;
                        animalListBody.innerHTML += row;
                    });
                }
            } catch (error) {
                console.error('Error fetching animal list:', error);
                if(animalListBody) animalListBody.innerHTML = '<tr><td colspan="5" class="p-6 text-red-500 text-center">Failed to load animal data.</td></tr>';
                if(noAnimalsMessage) noAnimalsMessage.classList.add('hidden');
            } finally {
                setLoading(false);
            }
        }
        
        // 3. Staff Management View (Updated)
        async function renderStaff() {
            pageSubtitle.textContent = 'Employee & Veterinary Staff Directory';
            const template = document.getElementById('staff-template').content.cloneNode(true);
            contentContainer.innerHTML = '';
            contentContainer.appendChild(template);

            await populateStaffOptions();

            const staffTypeSelect = document.getElementById('staffType');
            if (staffTypeSelect) staffTypeSelect.addEventListener('change', toggleStaffFields);
            
            const form = contentContainer.querySelector('#add-staff-form');
            if (form) {
                form.addEventListener('submit', handleAddStaff);
            }
            
            await fetchStaffList();
        }

        // Helper: Populates department, clinic, and supervisor dropdowns
        async function populateStaffOptions() {
            setLoading(true);
            try {
                const response = await window.mockFetch('/api/staff/options');
                const options = await response.json();

                const deptSelect = document.getElementById('deptID');
                const clinicSelect = document.getElementById('clinicID');
                const supervisorSelect = document.getElementById('supervisorID');
                
                // Departments
                options.departments.forEach(dept => {
                    if(deptSelect) deptSelect.innerHTML += `<option value="${dept.deptID}">${dept.deptName}</option>`;
                });

                // Clinics
                options.clinics.forEach(clinic => {
                    if(clinicSelect) clinicSelect.innerHTML += `<option value="${clinic.clinicID}">${clinic.clinicName} - ${clinic.location}</option>`;
                });

                // Supervisors
                options.supervisors.forEach(supervisor => {
                    if(supervisorSelect) supervisorSelect.innerHTML += `<option value="${supervisor.id}">${supervisor.name}</option>`;
                });

            } catch (error) {
                console.error('Error fetching staff options:', error);
                showMessage('Failed to load staff form options (Departments, Clinics).', 'text-red-600');
            } finally {
                setLoading(false);
            }
        }

        // Helper: Toggles form fields based on staff type
        function toggleStaffFields() {
            const type = document.getElementById('staffType').value;
            const employeeFields = document.getElementById('employee-fields');
            const vetFields = document.getElementById('vet-fields');

            if (employeeFields) employeeFields.classList.toggle('hidden', type !== 'employee');
            if (vetFields) vetFields.classList.toggle('hidden', type !== 'vet');

            // Set 'required' attributes dynamically for basic form validation
            if (employeeFields) {
                const employeeInputs = employeeFields.querySelectorAll('[required]');
                employeeInputs.forEach(input => input.required = (type === 'employee'));
            }
            if (vetFields) {
                const vetInputs = vetFields.querySelectorAll('[required]');
                vetInputs.forEach(input => input.required = (type === 'vet'));
            }
        }

        // Helper: Fetches and displays staff data (Updated with Delete button)
        async function fetchStaffList() {
            setLoading(true);
            const staffListBody = document.getElementById('staff-list');
            const noStaffMessage = document.getElementById('no-staff-message');
            
            if (staffListBody) staffListBody.innerHTML = ''; 

            try {
                const response = await window.mockFetch('/api/staff');
                const staff = await response.json();

                if (staff.length === 0) {
                    if (noStaffMessage) noStaffMessage.classList.remove('hidden');
                } else {
                    if (noStaffMessage) noStaffMessage.classList.add('hidden');
                    staff.forEach(person => {
                        const typeColor = person.type === 'Employee' ? 'bg-indigo-100 text-indigo-800' : 'bg-pink-100 text-pink-800';
                        const row = `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${person.firstName} ${person.lastName} (ID: ${person.personID})</div>
                                    <div class="text-xs text-gray-500">${person.email}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="font-semibold">${person.role}</span><br>
                                    <span class="text-xs">${person.department !== 'N/A' ? person.department : ''}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-normal text-sm text-gray-500 hidden sm:table-cell">
                                    ${person.details}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center flex items-center justify-center">
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${typeColor}">
                                        ${person.type}
                                    </span>
                                    <button data-id="${person.personID}" data-name="${person.firstName} ${person.lastName}" 
                                            class="remove-staff-btn ml-2 p-1 w-6 h-6 flex items-center justify-center bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors text-xs font-bold" title="Remove Staff">
                                        &times;
                                    </button>
                                </td>
                            </tr>
                        `;
                        staffListBody.innerHTML += row;
                    });
                    
                    // Add listener for delete buttons
                    staffListBody.addEventListener('click', (e) => {
                        if (e.target.classList.contains('remove-staff-btn')) {
                            const id = e.target.dataset.id;
                            const name = e.target.dataset.name;
                            handleRemoveStaff(id, name);
                        }
                    });

                }
            } catch (error) {
                console.error('Error fetching staff list:', error);
                if(staffListBody) staffListBody.innerHTML = '<tr><td colspan="4" class="p-6 text-red-500 text-center">Failed to load staff data.</td></tr>';
                if(noStaffMessage) noStaffMessage.classList.add('hidden');
            } finally {
                setLoading(false);
            }
        }
        
        function renderWIP() {
            pageSubtitle.textContent = 'Management Section (WIP)';
            const template = document.getElementById('wip-template').content.cloneNode(true);
            contentContainer.innerHTML = '';
            contentContainer.appendChild(template);
        }

        // --- Event Handlers ---

        // Handle navigation clicks (unchanged)
        navList.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                const newPage = e.target.dataset.page;
                if (newPage && newPage !== currentPage) {
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    currentPage = newPage;
                    loadPage(currentPage);
                }
            }
        });

        // Handle Add Animal Form Submission (Re-added full logic)
        async function handleAddAnimal(e) {
            e.preventDefault();
            
            const newAnimal = {
                animalName: document.getElementById('animalName').value,
                species: document.getElementById('species').value,
                breed: document.getElementById('breed').value,
                age: parseInt(document.getElementById('age').value) || null,
                gender: document.getElementById('gender').value,
                healthCondition: document.getElementById('healthCondition').value,
            };

            if (!newAnimal.animalName || !newAnimal.species || !newAnimal.gender) {
                showMessage('Please fill in required fields (Name, Species, Gender).', 'text-red-600', 'form-message-animal');
                return;
            }

            setLoading(true);
            try {
                const response = await window.mockFetch('/api/animals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newAnimal)
                });

                if (response.ok) {
                    const addedAnimal = await response.json();
                    showMessage(`Success! Added ${addedAnimal.animalName} (ID: ${addedAnimal.animalID}).`, 'text-green-600', 'form-message-animal');
                    e.target.reset(); 
                    await renderDashboard(); 
                    await fetchAnimalList(); 
                } else {
                    const error = await response.json();
                    showMessage(`Error: ${error.message || 'Failed to add animal.'}`, 'text-red-600', 'form-message-animal');
                }
            } catch (error) {
                console.error('Submission error:', error);
                showMessage('Network error during submission.', 'text-red-600', 'form-message-animal');
            } finally {
                setLoading(false);
            }
        }


        // Handle Add Staff Form Submission (unchanged)
        async function handleAddStaff(e) {
            e.preventDefault();
            
            const staffType = document.getElementById('staffType').value;
            
            if (!staffType) {
                showMessage('Please select a Staff Type (Employee or Vet).', 'text-red-600');
                return;
            }

            const staffData = {
                // Common Person Fields
                staffType: staffType,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phoneNo: document.getElementById('phoneNo').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                address: document.getElementById('address').value,
            };

            // Type-Specific Fields
            if (staffType === 'employee') {
                staffData.hireDate = document.getElementById('hireDate').value;
                staffData.position = document.getElementById('position').value;
                staffData.salary = document.getElementById('salary').value;
                staffData.employmentType = document.getElementById('employmentType').value;
                staffData.workShift = document.getElementById('workShift').value;
                staffData.deptID = document.getElementById('deptID').value;
                staffData.supervisorID = document.getElementById('supervisorID').value;
            } else if (staffType === 'vet') {
                staffData.vet_license_no = document.getElementById('vet_license_no').value;
                staffData.specialization = document.getElementById('specialization').value;
                staffData.years_of_experience = document.getElementById('years_of_experience').value;
                staffData.clinicID = document.getElementById('clinicID').value;
            }

            setLoading(true);
            try {
                const response = await window.mockFetch('/api/staff', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(staffData)
                });

                if (response.ok) {
                    const addedStaff = await response.json();
                    showMessage(`Success! Registered ${addedStaff.type}: ${addedStaff.firstName} ${addedStaff.lastName} (ID: ${addedStaff.personID}).`, 'text-green-600');
                    e.target.reset(); 
                    toggleStaffFields(); 
                    await renderDashboard(); 
                    await fetchStaffList(); 
                } else {
                    const error = await response.json();
                    showMessage(`Error: ${error.message || 'Failed to add staff member.'}`, 'text-red-600');
                }
            } catch (error) {
                console.error('Submission error:', error);
                showMessage('Network error during submission.', 'text-red-600');
            } finally {
                setLoading(false);
            }
        }

        // Handle Staff Member Removal (NEW)
        async function handleRemoveStaff(id, name) {
            const confirmed = await showConfirmModal(
                'Confirm Staff Deletion', 
                `Are you sure you want to permanently delete ${name} (ID: ${id})? This action cannot be undone and related assignments will be affected.`,
                'Yes, Delete'
            );

            if (!confirmed) {
                return;
            }
            
            setLoading(true);
            try {
                // DELETE request using the specific ID
                const response = await window.mockFetch(`/api/staff/${id}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    showMessage(`Success! Deleted staff member: ${name}.`, 'text-green-600');
                    await renderDashboard(); 
                    await fetchStaffList(); 
                } else {
                    const error = await response.json();
                    showMessage(`Error: ${error.message || 'Failed to delete staff member.'}`, 'text-red-600');
                }
            } catch (error) {
                console.error('Deletion error:', error);
                showMessage('Network error during deletion.', 'text-red-600');
            } finally {
                setLoading(false);
            }
        }


        // --- Page Loader ---

        function loadPage(page) {
            switch (page) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'animals':
                    renderAnimals();
                    break;
                case 'staff':
                    renderStaff();
                    break;
                case 'food':
                case 'clinics':
                case 'adopters':
                    renderWIP();
                    break;
                default:
                    renderStaff(); 
            }
        }

        // Initial setup
        window.onload = () => {
            const initialNav = document.querySelector(`[data-page="${currentPage}"]`);
            if (initialNav) {
                initialNav.classList.add('active');
            }
            loadPage(currentPage);
        };

        // Styling for nav items (added in JS since Tailwind is loaded late)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.add('block', 'p-2', 'rounded-lg', 'font-medium', 'text-blue-200', 'hover:bg-blue-800', 'transition-colors', 'mb-2');
        });

    </script>
</body>
</html>
