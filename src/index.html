<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Canin Admin Dashboard (LIVE DB)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .nav-item.active { background-color: #1e3a8a; color: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex">

    <!-- Firebase SDK Imports (MUST be defined before the script block) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, getDocs, runTransaction, query, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let staffOptions = { departments: [], clinics: [], supervisors: [] }; // Stored for form options

        // Utility to display transient form message
        function showMessage(msg, colorClass, targetId = 'form-message') {
            const formMessage = document.getElementById(targetId);
            if (formMessage) {
                formMessage.textContent = msg;
                formMessage.className = `mt-3 text-center text-sm font-medium ${colorClass}`;
                formMessage.classList.remove('hidden');
                setTimeout(() => {
                    formMessage.classList.add('hidden');
                }, 5000);
            }
        }

        // --- Firebase Initialization and Auth ---
        window.initFirebase = async () => {
            // setLogLevel('debug'); // Uncomment to see logs
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                showMessage('Error: Firebase configuration is missing. Cannot save data.', 'text-red-600', 'loading');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be ready
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase initialized. User ID:", userId);
                            resolve();
                        } else {
                            // If signed in anonymously, user object is still non-null
                            userId = auth.currentUser?.uid || 'anonymous-user';
                            console.log("Firebase initialized. User ID:", userId);
                            resolve();
                        }
                        unsubscribe();
                    });
                });
                
                // Fetch static options (Departments/Clinics) once
                await fetchStaticOptions();
                
                // Now that Firebase is ready, load the application content
                window.loadPage(window.currentPage);
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`Firebase Error: ${error.message}. Check console for details.`, 'text-red-600', 'loading');
            }
        };

        // --- Data Access Path Definitions (Private to this app instance and user) ---
        const COLLECTION_PATH_STAFF = (uid) => `artifacts/${appId}/users/${uid}/staff`;
        const COLLECTION_PATH_OPTIONS = (uid) => `artifacts/${appId}/users/${uid}/options`; // Using a simple options collection

        // --- Data Fetching and Management (Replacing Mock API) ---

        // 1. Fetch Static Data (Departments, Clinics) and mock initial employees/vets
        async function fetchStaticOptions() {
            // In a real app, these static lists might be in a public collection. Here, we set them up privately if they don't exist.
            const optionsRef = doc(db, COLLECTION_PATH_OPTIONS(userId), 'static_data');
            const optionsSnap = await getDoc(optionsRef);

            if (optionsSnap.exists()) {
                staffOptions = optionsSnap.data();
            } else {
                // Initialize default options (Mock Data Migration)
                const defaultOptions = {
                    departments: [
                        { id: 1, name: 'Animal Care' },
                        { id: 2, name: 'Administration' },
                        { id: 3, name: 'Medical & Health' },
                    ],
                    clinics: [
                        { id: 1, name: 'Vet Central Hospital', location: '1500 Elm Street' },
                        { id: 2, name: 'Happy Tails Clinic', location: '85 Pet Avenue' },
                    ],
                };
                await setDoc(optionsRef, defaultOptions);
                staffOptions = defaultOptions;
            }
        }
        
        // 2. Add New Staff Member (Firestore Write)
        window.handleAddStaff = async (e) => {
            e.preventDefault();
            
            const staffType = document.getElementById('staffType').value;
            const staffForm = e.target;

            if (!staffType) {
                showMessage('Please select a Staff Type (Employee or Vet).', 'text-red-600');
                return;
            }
            
            // Generate a unique ID for the new staff member (PersonID)
            const staffID = doc(collection(db, COLLECTION_PATH_STAFF(userId))).id;

            const staffData = {
                // Common Person Fields
                id: staffID,
                staffType: staffType,
                firstName: staffForm.firstName.value,
                lastName: staffForm.lastName.value,
                email: staffForm.email.value,
                phoneNo: staffForm.phoneNo.value,
                age: parseInt(staffForm.age.value) || 0,
                gender: staffForm.gender.value,
                address: staffForm.address.value,
            };

            // Type-Specific Fields
            if (staffType === 'employee') {
                staffData.hireDate = staffForm.hireDate.value;
                staffData.position = staffForm.position.value;
                staffData.salary = parseFloat(staffForm.salary.value) || 0;
                staffData.employmentType = staffForm.employmentType.value;
                staffData.workShift = staffForm.workShift.value;
                staffData.deptID = parseInt(staffForm.deptID.value);
                staffData.supervisorID = staffForm.supervisorID.value ? parseInt(staffForm.supervisorID.value) : null;
                staffData.roleDetails = `Salary: $${staffData.salary.toFixed(2)}, Hired: ${staffData.hireDate}`;
                staffData.departmentName = staffOptions.departments.find(d => d.id === staffData.deptID)?.name || 'N/A';
                
            } else if (staffType === 'vet') {
                staffData.vet_license_no = staffForm.vet_license_no.value;
                staffData.specialization = staffForm.specialization.value;
                staffData.years_of_experience = parseInt(staffForm.years_of_experience.value) || 0;
                staffData.clinicID = parseInt(staffForm.clinicID.value);
                staffData.roleDetails = `License: ${staffData.vet_license_no}, Exp: ${staffData.years_of_experience} yrs`;
                staffData.departmentName = staffOptions.clinics.find(c => c.id === staffData.clinicID)?.name || 'N/A';
            }

            window.setLoading(true);
            try {
                // Use the generated ID as the document ID for the single denormalized staff record
                await setDoc(doc(db, COLLECTION_PATH_STAFF(userId), staffID), staffData);

                showMessage(`Success! Registered ${staffType}: ${staffData.firstName} ${staffData.lastName}.`, 'text-green-600');
                e.target.reset(); 
                window.toggleStaffFields(); 
            } catch (error) {
                console.error('Firestore Add Staff Error:', error);
                showMessage(`Error: Failed to register staff member. ${error.message}`, 'text-red-600');
            } finally {
                window.setLoading(false);
            }
        };

        // 3. Remove Staff Member (Firestore Delete)
        window.handleRemoveStaff = async (id, name) => {
            const confirmed = await window.showConfirmModal(
                'Confirm Staff Deletion', 
                `Are you sure you want to permanently delete ${name} (ID: ${id})? This action cannot be undone.`,
                'Yes, Delete'
            );

            if (!confirmed) {
                return;
            }
            
            window.setLoading(true);
            try {
                // Delete the single denormalized staff record
                await deleteDoc(doc(db, COLLECTION_PATH_STAFF(userId), id));

                showMessage(`Success! Deleted staff member: ${name}.`, 'text-green-600');
            } catch (error) {
                console.error('Firestore Deletion Error:', error);
                showMessage(`Error: Failed to delete staff member. ${error.message}`, 'text-red-600');
            } finally {
                window.setLoading(false);
            }
        }
        
        // 4. Real-time Staff List Listener
        window.fetchStaffListRealtime = async () => {
            const staffListBody = document.getElementById('staff-list');
            const noStaffMessage = document.getElementById('no-staff-message');

            if (!db || !userId) return;

            const q = query(collection(db, COLLECTION_PATH_STAFF(userId)));
            
            // onSnapshot sets up a continuous listener
            onSnapshot(q, (querySnapshot) => {
                const staff = [];
                querySnapshot.forEach((doc) => {
                    staff.push(doc.data());
                });

                // Clear and render the new list
                if (staffListBody) staffListBody.innerHTML = ''; 

                if (staff.length === 0) {
                    if (noStaffMessage) noStaffMessage.classList.remove('hidden');
                } else {
                    if (noStaffMessage) noStaffMessage.classList.add('hidden');
                    
                    staff.sort((a, b) => a.lastName.localeCompare(b.lastName)).forEach(person => {
                        const typeColor = person.staffType === 'employee' ? 'bg-indigo-100 text-indigo-800' : 'bg-pink-100 text-pink-800';
                        const row = `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${person.firstName} ${person.lastName} (ID: ${person.id})</div>
                                    <div class="text-xs text-gray-500">${person.email}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="font-semibold">${person.specialization || person.position || 'N/A'}</span><br>
                                    <span class="text-xs">${person.departmentName || 'N/A'}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-normal text-sm text-gray-500 hidden sm:table-cell">
                                    ${person.roleDetails || 'N/A'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center flex items-center justify-center">
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${typeColor}">
                                        ${person.staffType === 'employee' ? 'Employee' : 'Vet'}
                                    </span>
                                    <button data-id="${person.id}" data-name="${person.firstName} ${person.lastName}" 
                                            class="remove-staff-btn ml-2 p-1 w-6 h-6 flex items-center justify-center bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors text-xs font-bold" title="Remove Staff">
                                        &times;
                                    </button>
                                </td>
                            </tr>
                        `;
                        if (staffListBody) staffListBody.innerHTML += row;
                    });

                    // Re-attach listener for delete buttons on the table body itself
                    // We use event delegation on the body which survives re-renders
                    if(staffListBody) {
                         staffListBody.onclick = (e) => {
                            if (e.target.classList.contains('remove-staff-btn')) {
                                const id = e.target.dataset.id;
                                const name = e.target.dataset.name;
                                window.handleRemoveStaff(id, name);
                            }
                        };
                    }
                }
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                if(staffListBody) staffListBody.innerHTML = '<tr><td colspan="4" class="p-6 text-red-500 text-center">Failed to load real-time staff data.</td></tr>';
                if(noStaffMessage) noStaffMessage.classList.add('hidden');
            });
        }

        // --- Shared Application Logic (Moved to global scope for module access) ---
        window.staffOptions = staffOptions;
        window.userId = userId;

        window.setLoading = (isLoading) => {
            const loadingElement = document.getElementById('loading');
            const contentContainer = document.getElementById('content-container');
            if (loadingElement) loadingElement.classList.toggle('hidden', !isLoading);
            if (contentContainer) contentContainer.classList.toggle('opacity-50', isLoading);
        };
        
        window.showConfirmModal = (title, message, confirmText = 'Confirm Delete', confirmColor = 'bg-red-600') => {
            // (Modal implementation remains the same, but defined outside of module for accessibility)
            const modal = document.getElementById('confirm-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            confirmBtn.className = confirmBtn.className.replace(/bg-([a-z]+)-600/g, 'bg-red-600'); 
            confirmBtn.classList.remove('bg-red-600'); 
            confirmBtn.classList.add(confirmColor);
            confirmBtn.textContent = confirmText;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex'); 

            return new Promise(resolve => {
                const handleConfirm = () => {
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                };

                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }
    </script>


    <!-- Sidebar Navigation -->
    <nav class="w-64 bg-blue-900 h-screen p-4 sticky top-0 shadow-xl">
        <h2 class="text-2xl font-bold text-white mb-8">Shelter Admin</h2>
        <ul id="nav-list">
            <li><a href="#" data-page="dashboard" class="nav-item">üè† Dashboard (WIP)</a></li>
            <li><a href="#" data-page="animals" class="nav-item">üêæ Animals (WIP)</a></li>
            <li><a href="#" data-page="staff" class="nav-item active">üë• Staff & Vets</a></li>
            <li class="mt-4 text-gray-400 font-semibold text-sm uppercase">Quick Links</li>
            <li><a href="#" data-page="food" class="nav-item">üõí Food & Supply (WIP)</a></li>
            <li><a href="#" data-page="clinics" class="nav-item">üè• Clinics & Meds (WIP)</a></li>
            <li><a href="#" data-page="adopters" class="nav-item">üß° Adopters (WIP)</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800">Royal Canin Animal Shelter</h1>
            <p class="text-xl text-gray-500" id="page-subtitle">Database Management Dashboard</p>
        </header>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-10 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-blue-600">Connecting to Real-time Database...</p>
        </div>

        <!-- Content Placeholder -->
        <div id="content-container">
            <!-- Dynamic content will be loaded here -->
        </div>

        <!-- Hidden Templates for Pages (Only Staff is fully implemented with Firestore) -->
        <template id="staff-template">
            <!-- Add New Staff Form -->
            <section class="mb-10 p-6 bg-white shadow-lg rounded-xl">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Register New Employee or Vet</h2>
                <form id="add-staff-form">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <!-- Staff Type Selector (The central switch) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Staff Type</label>
                            <select id="staffType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="" disabled selected>Select Role Type</option>
                                <option value="employee">Shelter Employee</option>
                                <option value="vet">Affiliated Vet</option>
                            </select>
                        </div>
                    </div>

                    <!-- General Person Fields (Always visible) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg">
                        <h3 class="md:col-span-4 text-lg font-semibold text-gray-800 border-b pb-2 mb-3">General Information (Person)</h3>
                        <input type="text" name="firstName" placeholder="First Name" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="text" name="lastName" placeholder="Last Name" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="email" name="email" placeholder="Email Address" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="text" name="phoneNo" placeholder="Phone Number" class="p-3 border border-gray-300 rounded-lg">
                        <input type="number" name="age" placeholder="Age" min="18" max="100" required class="p-3 border border-gray-300 rounded-lg">
                        <select name="gender" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Gender</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="O">Other</option>
                        </select>
                        <input type="text" name="address" placeholder="Address (Street, City, State)" class="md:col-span-2 p-3 border border-gray-300 rounded-lg">
                    </div>

                    <!-- EMPLOYEE Specific Fields -->
                    <div id="employee-fields" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg bg-blue-50 hidden">
                        <h3 class="md:col-span-4 text-lg font-semibold text-blue-700 border-b pb-2 mb-3">Employee Details</h3>
                        <input type="date" name="hireDate" placeholder="Hire Date" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="text" name="position" placeholder="Position (e.g., Coordinator)" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="number" name="salary" placeholder="Annual Salary" min="0" required class="p-3 border border-gray-300 rounded-lg">
                        <select name="employmentType" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Employment Type</option>
                            <option value="Full-time">Full-time</option>
                            <option value="Part-time">Part-time</option>
                        </select>
                        <select name="workShift" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Work Shift</option>
                            <option value="Day">Day</option>
                            <option value="Afternoon">Afternoon</option>
                            <option value="Night">Night</option>
                        </select>
                        <select name="deptID" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Select Department</option>
                        </select>
                        <select name="supervisorID" class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="">Select Supervisor (Optional)</option>
                        </select>
                    </div>

                    <!-- VET Specific Fields -->
                    <div id="vet-fields" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg bg-pink-50 hidden">
                        <h3 class="md:col-span-4 text-lg font-semibold text-pink-700 border-b pb-2 mb-3">Vet Details</h3>
                        <input type="text" name="vet_license_no" placeholder="License Number" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="text" name="specialization" placeholder="Specialization (e.g., Surgery)" required class="p-3 border border-gray-300 rounded-lg">
                        <input type="number" name="years_of_experience" placeholder="Years of Experience" min="0" required class="p-3 border border-gray-300 rounded-lg">
                        <select name="clinicID" required class="p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Affiliated Clinic</option>
                        </select>
                    </div>

                    <button type="submit" class="w-full p-3 mt-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                        Register Staff Member
                    </button>
                </form>
                <div id="form-message" class="mt-3 text-center text-sm font-medium hidden"></div>
            </section>

            <!-- Staff List Section -->
            <section>
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Staff Directory (Real-time DB)</h2>
                <div id="staff-list-container" class="bg-white shadow-lg rounded-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name / Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role / Dept/Clinic</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Details</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Type / Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staff-list" class="bg-white divide-y divide-gray-200">
                            <!-- Staff rows will be inserted here -->
                            <tr><td colspan="4" class="p-6 text-gray-500 text-center">Loading staff data from database...</td></tr>
                        </tbody>
                    </table>
                    <p id="no-staff-message" class="text-center p-6 text-gray-500 hidden">No staff members found.</p>
                </div>
            </section>
        </template>

        <template id="wip-template">
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                <p class="font-bold">Work In Progress</p>
                <p>This section is not yet linked to the database. Please use the **Staff & Vets** page for live data management.</p>
            </div>
        </template>
    </main>
    
    <!-- Custom Confirmation Modal (Replaces alert/confirm) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold text-red-700 mb-4" id="modal-title">Confirm Action</h3>
            <p class="text-gray-700 mb-6" id="modal-message">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold">Confirm Delete</button>
            </div>
        </div>
    </div>


    <!-- Frontend JavaScript Logic -->
    <script type="module">
        import { initFirebase, staffOptions, fetchStaffListRealtime, handleAddStaff } from './index.html'; // Import functions from the module scope

        const contentContainer = document.getElementById('content-container');
        const pageSubtitle = document.getElementById('page-subtitle');
        window.currentPage = 'staff'; 

        // Helper: Toggles form fields based on staff type
        window.toggleStaffFields = () => {
            const type = document.getElementById('staffType')?.value;
            const employeeFields = document.getElementById('employee-fields');
            const vetFields = document.getElementById('vet-fields');

            if (employeeFields) employeeFields.classList.toggle('hidden', type !== 'employee');
            if (vetFields) vetFields.classList.toggle('hidden', type !== 'vet');

            // Populate DDLs and set required attributes
            const deptSelect = document.querySelector('select[name="deptID"]');
            const clinicSelect = document.querySelector('select[name="clinicID"]');
            
            // Populate Dropdowns if they are currently empty
            if (deptSelect && deptSelect.options.length <= 1) {
                window.staffOptions.departments.forEach(dept => {
                    deptSelect.innerHTML += `<option value="${dept.id}">${dept.name}</option>`;
                });
            }
            if (clinicSelect && clinicSelect.options.length <= 1) {
                window.staffOptions.clinics.forEach(clinic => {
                    clinicSelect.innerHTML += `<option value="${clinic.id}">${clinic.name} - ${clinic.location}</option>`;
                });
            }
            
            if (employeeFields) {
                employeeFields.querySelectorAll('[required]').forEach(input => input.required = (type === 'employee'));
            }
            if (vetFields) {
                vetFields.querySelectorAll('[required]').forEach(input => input.required = (type === 'vet'));
            }
        }
        
        // --- Page Loader ---

        window.renderStaff = () => {
            pageSubtitle.textContent = 'Employee & Veterinary Staff Directory (Live DB)';
            const template = document.getElementById('staff-template').content.cloneNode(true);
            contentContainer.innerHTML = '';
            contentContainer.appendChild(template);
            
            const staffTypeSelect = document.getElementById('staffType');
            if (staffTypeSelect) staffTypeSelect.addEventListener('change', window.toggleStaffFields);
            
            const form = contentContainer.querySelector('#add-staff-form');
            if (form) {
                // Attach the imported Firestore handler function
                form.addEventListener('submit', window.handleAddStaff);
            }
            
            // Initial call to set up the real-time listener
            window.toggleStaffFields();
            window.fetchStaffListRealtime();
        }

        function renderWIP() {
            pageSubtitle.textContent = 'Management Section (WIP)';
            const template = document.getElementById('wip-template').content.cloneNode(true);
            contentContainer.innerHTML = '';
            contentContainer.appendChild(template);
        }

        window.loadPage = (page) => {
            switch (page) {
                case 'dashboard':
                case 'animals':
                case 'food':
                case 'clinics':
                case 'adopters':
                    renderWIP();
                    break;
                case 'staff':
                    window.renderStaff();
                    break;
                default:
                    window.renderStaff(); 
            }
        }

        // Handle navigation clicks
        document.getElementById('nav-list').addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                const newPage = e.target.dataset.page;
                if (newPage && newPage !== window.currentPage) {
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    window.currentPage = newPage;
                    window.loadPage(window.currentPage);
                }
            }
        });

        // Styling for nav items (added in JS since Tailwind is loaded late)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.add('block', 'p-2', 'rounded-lg', 'font-medium', 'text-blue-200', 'hover:bg-blue-800', 'transition-colors', 'mb-2');
        });
        
        // --- Application Start ---
        window.setLoading(true);
        window.initFirebase();
    </script>
</body>
</html>
